{
  "assignees": [],
  "body": "## Summary\n\n`eabctl threads snapshot` command that dumps all Zephyr thread names, states, priorities, and stack high-water marks via GDB Python. Continuous monitoring mode and `stack_headroom_assert` HIL step.\n\n## What to build\n\n1. New module `eab/thread_inspector.py`\n   - `ThreadInfo` dataclass: name, state, priority, stack_base, stack_size, stack_used, stack_free\n   - `inspect_threads(device, elf_path) -> list[ThreadInfo]`\n   - GDB Python script that walks `_kernel.threads` linked list (Zephyr internal structure)\n   - Extract: thread name, state (RUNNING/READY/PENDING/SUSPENDED), priority, stack base/size, stack usage high-water mark\n   - Pure GDB one-shot approach (no persistent session needed)\n\n2. New CLI commands `eabctl threads`\n   - `eabctl threads snapshot --device NRF5340_XXAA_APP --elf zephyr.elf --json`\n     - Output: JSON array of ThreadInfo objects\n   - `eabctl threads watch --device NRF5340_XXAA_APP --elf zephyr.elf --interval 5 --json`\n     - Periodic polling, JSONL stream output\n\n3. New HIL regression step `stack_headroom_assert`\n   ```yaml\n   steps:\n     - stack_headroom_assert:\n         min_free_bytes: 256\n         elf: build/zephyr/zephyr.elf\n         device: NRF5340_XXAA_APP\n   ```\n   Fails if any thread has less than `min_free_bytes` stack remaining.\n\n4. New MCP tool `get_thread_state` in `eab/mcp_server.py`\n\n5. Unit tests in `tests/unit/test_thread_inspector.py`\n   - Mock GDB Python output (simulated `_kernel.threads` traversal)\n   - Test ThreadInfo parsing, stack headroom calculation\n   - Test CLI output formatting, watch mode JSONL\n   - Test HIL step pass/fail logic\n\n## Zephyr thread list internals\n\nZephyr maintains a linked list at `_kernel.threads`. Each `struct k_thread` has:\n- `name` \u2014 thread name string (if `CONFIG_THREAD_NAME=y`)\n- `base.thread_state` \u2014 state flags\n- `base.prio` \u2014 priority\n- `stack_info.start` \u2014 stack base address\n- `stack_info.size` \u2014 stack allocation size\n- `stack_info.delta` \u2014 stack usage (if `CONFIG_THREAD_STACK_INFO=y`)\n\nGDB can traverse: `set $t = _kernel.threads; while ($t) { ... ; set $t = $t->next_thread; }`\n\n## Existing code to reuse\n\n- `eab/gdb_bridge.py` \u2014 GDB one-shot command execution\n- `eab/dwt_profiler.py` \u2014 GDB Python script pattern (conditional watchpoints use this)\n- `eab/mcp_server.py` \u2014 MCP tool registration\n- `eab/cli/regression/steps.py` \u2014 step dispatch pattern\n\n## Acceptance criteria\n\n- `eabctl threads snapshot` returns all Zephyr threads with stack info\n- Watch mode streams JSONL at configurable interval\n- `stack_headroom_assert` HIL step passes/fails correctly\n- MCP tool works\n- All new tests pass\n- Existing 1403 tests still pass",
  "comments": [],
  "createdAt": "2026-02-26T22:29:11Z",
  "labels": [],
  "number": 136,
  "title": "RTOS Thread Stack Inspector (Zephyr-first)",
  "updatedAt": "2026-02-26T22:29:11Z",
  "url": "https://github.com/shanemmattner/embedded-agent-bridge/issues/136",
  "fetched_at": "2026-02-26T22:29:32.854584+00:00"
}