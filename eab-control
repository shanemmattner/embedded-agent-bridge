#!/bin/bash
# EAB Daemon Control Script
# Usage: eab-control [start|stop|restart|status|logs|enable|disable]

PLIST="$HOME/Library/LaunchAgents/com.eab.daemon.plist"
EAB_DIR="$HOME/tools/embedded-agent-bridge"

case "$1" in
    start)
        echo "Starting EAB daemon..."
        launchctl load "$PLIST" 2>/dev/null || launchctl start com.eab.daemon
        sleep 2
        if launchctl list | grep -q com.eab.daemon; then
            echo "EAB daemon started"
            cd "$EAB_DIR" && python3 -m eab --status
        else
            echo "Failed to start daemon. Check logs with: eab-control logs"
        fi
        ;;

    stop)
        echo "Stopping EAB daemon..."
        launchctl stop com.eab.daemon 2>/dev/null
        launchctl unload "$PLIST" 2>/dev/null
        # Also kill any orphaned processes
        pkill -f "python3 -m eab" 2>/dev/null
        echo "EAB daemon stopped"
        ;;

    restart)
        $0 stop
        sleep 2
        $0 start
        ;;

    status)
        echo "=== LaunchAgent Status ==="
        if launchctl list | grep -q com.eab.daemon; then
            echo "Service: LOADED"
            launchctl list com.eab.daemon
        else
            echo "Service: NOT LOADED"
        fi
        echo ""
        echo "=== EAB Daemon Status ==="
        cd "$EAB_DIR" && python3 -m eab --status
        echo ""
        echo "=== Session Files ==="
        ls -la /tmp/eab-session/ 2>/dev/null || echo "No session directory"
        ;;

    logs)
        echo "=== Daemon stdout ==="
        tail -50 /tmp/eab-daemon.log 2>/dev/null || echo "No stdout log"
        echo ""
        echo "=== Daemon stderr ==="
        tail -50 /tmp/eab-daemon.err 2>/dev/null || echo "No stderr log"
        echo ""
        echo "=== Session latest.log ==="
        tail -30 /tmp/eab-session/latest.log 2>/dev/null || echo "No session log"
        ;;

    enable)
        echo "Enabling EAB daemon to start at login..."
        launchctl load "$PLIST"
        echo "Done. EAB will start automatically when you log in."
        ;;

    disable)
        echo "Disabling EAB daemon..."
        launchctl unload "$PLIST" 2>/dev/null
        echo "Done. EAB will not start automatically."
        ;;

    pause)
        SECONDS="${2:-120}"
        echo "Pausing EAB daemon for ${SECONDS}s to release serial port..."
        cd "$EAB_DIR" && python3 -m eab --pause "$SECONDS"
        ;;

    resume)
        echo "Resuming EAB daemon (removing pause file)..."
        rm -f /tmp/eab-session/pause.txt
        echo "Daemon will resume on next loop iteration."
        ;;

    reset)
        echo "Sending reset command to ESP32..."
        cd "$EAB_DIR" && python3 -m eab --reset
        ;;

    cmd)
        if [ -z "$2" ]; then
            echo "Usage: eab-control cmd <command>"
            echo "Example: eab-control cmd '!CHIP_INFO'"
            exit 1
        fi
        cd "$EAB_DIR" && python3 -m eab --cmd "$2"
        ;;

    tail)
        LINES="${2:-50}"
        cd "$EAB_DIR" && python3 -m eab --logs "$LINES"
        ;;

    alerts)
        LINES="${2:-20}"
        cd "$EAB_DIR" && python3 -m eab --alerts "$LINES"
        ;;

    wait)
        if [ -z "$2" ]; then
            echo "Usage: eab-control wait <pattern> [timeout]"
            echo "Example: eab-control wait 'Ready' 30"
            exit 1
        fi
        TIMEOUT="${3:-30}"
        cd "$EAB_DIR" && python3 -m eab --wait-for "$2" --wait-timeout "$TIMEOUT"
        ;;

    *)
        echo "EAB Daemon Control"
        echo ""
        echo "Usage: eab-control [command]"
        echo ""
        echo "Daemon Commands:"
        echo "  start      - Start the daemon now"
        echo "  stop       - Stop the daemon"
        echo "  restart    - Restart the daemon"
        echo "  status     - Show daemon status"
        echo "  logs       - Show daemon logs (stdout/stderr)"
        echo "  enable     - Enable auto-start at login"
        echo "  disable    - Disable auto-start"
        echo ""
        echo "Port Control:"
        echo "  pause [N]  - Pause for N seconds (default 120) to release serial port"
        echo "  resume     - Resume from pause early"
        echo ""
        echo "Device Control:"
        echo "  reset      - Reset the ESP32 device"
        echo "  cmd <cmd>  - Send command (e.g., '!CHIP_INFO', '!BOOTLOADER')"
        echo ""
        echo "Log Viewing:"
        echo "  tail [N]   - Show last N lines from serial log (default 50)"
        echo "  alerts [N] - Show last N alert lines (default 20)"
        echo "  wait <pat> - Wait for log line matching pattern"
        echo ""
        echo "Session files are in /tmp/eab-session/"
        ;;
esac
