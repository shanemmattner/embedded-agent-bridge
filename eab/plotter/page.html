<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EAB RTT Plotter</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
    background: #1a1a2e;
    color: #e0e0e0;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: #16213e;
    border-bottom: 1px solid #0f3460;
  }
  header h1 {
    font-size: 14px;
    font-weight: 600;
    color: #e94560;
  }
  #status {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 3px;
  }
  .connected { background: #1b4332; color: #95d5b2; }
  .disconnected { background: #5c1a1a; color: #f4a0a0; }
  #status-banner {
    display: none;
    padding: 6px 16px;
    font-size: 12px;
    border-bottom: 1px solid;
  }
  #status-banner.info {
    background: #1b3a4b;
    color: #7ec8e3;
    border-color: #2a5a6b;
  }
  #status-banner.error {
    background: #4a1a1a;
    color: #f4a0a0;
    border-color: #6a2a2a;
  }
  #status-banner.warn {
    background: #4a3a1a;
    color: #f4d08f;
    border-color: #6a5a2a;
  }
  #state-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 6px 16px;
    background: #16213e;
    border-bottom: 1px solid #0f3460;
    font-size: 12px;
  }
  #state-value {
    font-weight: 700;
    color: #00d2ff;
    font-size: 14px;
  }
  .stat { color: #888; }
  .stat b { color: #ccc; }
  #chart { flex: 1; min-height: 0; }
</style>
</head>
<body>
<header>
  <h1>EAB RTT Plotter</h1>
  <span id="status" class="disconnected">disconnected</span>
</header>
<div id="status-banner"></div>
<div id="state-bar">
  <span>State: <span id="state-value">--</span></span>
  <span class="stat">Points: <b id="point-count">0</b></span>
  <span class="stat">Rate: <b id="data-rate">0</b>/s</span>
</div>
<div id="chart"></div>

<script>
const MAX_POINTS = 500;
const WS_URL = `ws://${location.host}`;
const HEARTBEAT_STALE_MS = 6000;

// --- Data storage ---
const traces = {};       // { name: { x: [], y: [] } }
const traceIndices = {}; // { name: plotly trace index }
let pointCount = 0;
let rateCounter = 0;
let traceCount = 0;
let lastHeartbeat = 0;
let statusDismissTimer = null;

// Colors for traces
const COLORS = [
  '#e94560', '#00d2ff', '#53d769', '#ff9f43',
  '#a29bfe', '#fd79a8', '#ffeaa7', '#74b9ff',
];

// --- Status banner ---
function showStatusBanner(message, severity) {
  const banner = document.getElementById('status-banner');
  banner.textContent = message;
  banner.className = severity || 'info';
  banner.style.display = 'block';

  if (statusDismissTimer) clearTimeout(statusDismissTimer);
  if (severity !== 'error') {
    statusDismissTimer = setTimeout(() => {
      banner.style.display = 'none';
    }, 10000);
  }
}

function hideStatusBanner() {
  document.getElementById('status-banner').style.display = 'none';
}

// --- Plotly setup ---
const layout = {
  paper_bgcolor: '#1a1a2e',
  plot_bgcolor: '#1a1a2e',
  font: { color: '#e0e0e0', size: 11 },
  margin: { t: 10, r: 60, b: 40, l: 60 },
  xaxis: {
    title: 'Sample',
    gridcolor: '#2a2a4a',
    zerolinecolor: '#2a2a4a',
  },
  yaxis: {
    title: 'Signals',
    gridcolor: '#2a2a4a',
    zerolinecolor: '#2a2a4a',
  },
  yaxis2: {
    title: 'Temperature',
    overlaying: 'y',
    side: 'right',
    gridcolor: 'transparent',
  },
  legend: {
    bgcolor: 'rgba(22,33,62,0.8)',
    bordercolor: '#0f3460',
    borderwidth: 1,
    x: 0.01,
    y: 0.99,
  },
  showlegend: true,
};

const config = {
  responsive: true,
  displayModeBar: false,
};

Plotly.newPlot('chart', [], layout, config);

// Resize chart to fill available space
function resizeChart() {
  const el = document.getElementById('chart');
  const rect = el.getBoundingClientRect();
  Plotly.relayout('chart', { width: rect.width, height: rect.height });
}
window.addEventListener('resize', resizeChart);
setTimeout(resizeChart, 100);

// --- Add a new trace dynamically ---
function ensureTrace(name) {
  if (traces[name]) return;

  const idx = traceCount;
  const color = COLORS[idx % COLORS.length];

  // Put "temp" on secondary y-axis
  const isTemp = name.toLowerCase().includes('temp');

  traces[name] = { x: [], y: [] };
  traceIndices[name] = idx;
  traceCount++;

  Plotly.addTraces('chart', {
    x: [],
    y: [],
    name: name,
    type: 'scattergl',
    mode: 'lines',
    line: { color: color, width: isTemp ? 1.5 : 2 },
    yaxis: isTemp ? 'y2' : 'y',
  });
}

// --- Push data point ---
function pushData(values) {
  pointCount++;
  rateCounter++;

  const update = { x: [], y: [] };
  const indices = [];

  for (const [name, val] of Object.entries(values)) {
    ensureTrace(name);
    const t = traces[name];
    t.x.push(pointCount);
    t.y.push(val);

    // Trim to MAX_POINTS
    if (t.x.length > MAX_POINTS) {
      t.x.shift();
      t.y.shift();
    }

    const idx = traceIndices[name];
    update.x.push([...t.x]);
    update.y.push([...t.y]);
    indices.push(idx);
  }

  // Full restyle (Plotly.extendTraces has issues with trimming)
  Plotly.restyle('chart', update, indices);

  // Update x-axis range for scrolling window
  if (pointCount > MAX_POINTS) {
    Plotly.relayout('chart', {
      'xaxis.range': [pointCount - MAX_POINTS, pointCount],
    });
  }

  document.getElementById('point-count').textContent = pointCount;
}

// --- WebSocket connection ---
let ws = null;
let reconnectTimer = null;

function connect() {
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    document.getElementById('status').textContent = 'connected';
    document.getElementById('status').className = 'connected';
    lastHeartbeat = Date.now();
  };

  ws.onclose = () => {
    document.getElementById('status').textContent = 'disconnected';
    document.getElementById('status').className = 'disconnected';
    // Reconnect after 2s
    reconnectTimer = setTimeout(connect, 2000);
  };

  ws.onerror = () => ws.close();

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'data') {
      pushData(msg.values);
    } else if (msg.type === 'state') {
      document.getElementById('state-value').textContent = msg.state;
    } else if (msg.type === 'status') {
      const severity = msg.message.toLowerCase().includes('died') ||
                       msg.message.toLowerCase().includes('failed') ? 'error' :
                       msg.message.toLowerCase().includes('disconnect') ||
                       msg.message.toLowerCase().includes('reconnect') ? 'warn' : 'info';
      showStatusBanner(msg.message, severity);
    } else if (msg.type === 'heartbeat') {
      lastHeartbeat = Date.now();
    }
  };
}

connect();

// --- Data rate counter + heartbeat staleness check ---
setInterval(() => {
  document.getElementById('data-rate').textContent = rateCounter;
  rateCounter = 0;

  // Check heartbeat staleness
  if (lastHeartbeat > 0 && (Date.now() - lastHeartbeat) > HEARTBEAT_STALE_MS) {
    const statusEl = document.getElementById('status');
    if (statusEl.className === 'connected') {
      showStatusBanner('No heartbeat from server â€” connection may be stale', 'warn');
    }
  }
}, 1000);
</script>
</body>
</html>
