# Embedded Agent Bridge (EAB)

> ESP32 serial communication daemon. ALWAYS use eab-control for ALL ESP32 operations.

## CRITICAL: DO NOT USE THESE DIRECTLY
- esptool
- pio device monitor
- Serial port access (/dev/cu.* or /dev/tty.*)

## USE THESE INSTEAD

Check status:
    ./eab-control status
    ./eab-control status --json

View serial output:
    ./eab-control tail 50
    ./eab-control tail 50 --json

View daemon events (non-blocking JSONL):
    ./eab-control events 50
    ./eab-control events 50 --json

Flash firmware:
    ./eab-control flash /path/to/project

Reset device:
    ./eab-control reset

Send command:
    ./eab-control send "text"
    ./eab-control wait-event --type command_sent --timeout 10

High-speed data stream:
    ./eab-control stream start --mode raw --chunk 16384 --marker "===DATA_START===" --no-patterns --truncate
    ./eab-control recv-latest --bytes 65536 --out latest.bin
    ./eab-control stream stop

Run diagnostics:
    ./eab-control diagnose
    ./eab-control diagnose --json

Extract base64 payload between markers:
    ./eab-control capture-between "===WAV_START===" "===WAV_END===" out.b64
    ./eab-control capture-between "===WAV_START===" "===WAV_END===" out.wav --decode-base64

Pre-flight check (run before flashing):
    ./eab-control preflight

## WHY

The EAB daemon manages the serial port. If you access it directly, you get "port busy" errors.
eab-control automatically pauses the daemon, does the operation, and resumes.

## TROUBLESHOOTING

Port busy error     -> Use eab-control flash instead of esptool
No output           -> eab-control status && eab-control reset
Boot loop           -> eab-control flash /path/to/working/project
Flash failed        -> eab-control preflight (diagnose issues)

## STATUS FILE

Check /tmp/eab-session/status.json for:
- connection.status: connected/reconnecting/disconnected
- health.status: healthy/idle/stuck/disconnected
- health.idle_seconds: seconds since last activity

## EVENT STREAM

Check /tmp/eab-session/events.jsonl for JSONL event records (pause/resume, flash, alerts, commands).

## DATA STREAM

When enabled, raw bytes are written to /tmp/eab-session/data.bin.
Binary framing is **optional** and only applies when custom firmware is allowed (see PROTOCOL.md).
