# Task Completion Report: Add `--no-stub` and `--extra-esptool-args` CLI Flags

## Summary

Successfully added two new CLI flags to the `eabctl flash` subcommand:
- `--no-stub`: Boolean flag to use ROM bootloader directly (slower but more reliable for USB-JTAG)
- `--extra-esptool-args`: Variable-length argument list for passing arbitrary flags to esptool

## Files Modified

### 1. `eab/cli/__init__.py`

**Parser Definition (lines 389-393):**
- Added `--no-stub` argument with `action='store_true'` and appropriate help text
- Added `--extra-esptool-args` argument with `nargs='*'`, `default=[]`, and help text with example usage

**Main Dispatch (lines 707-708):**
- Added `no_stub=args.no_stub` parameter when calling `cmd_flash()`
- Added `extra_esptool_args=getattr(args, 'extra_esptool_args', [])` parameter when calling `cmd_flash()`

### 2. `eab/tests/test_esp32_commands.py`

**New Tests (lines 511-533):**
- Added `test_eabctl_flash_help_includes_no_stub()` to verify `--no-stub` appears in help output with appropriate descriptive text
- Added `test_eabctl_flash_help_includes_extra_esptool_args()` to verify `--extra-esptool-args` appears in help output with appropriate descriptive text

## Implementation Details

### Parameter Flow

1. **CLI Parsing**: Arguments are parsed by argparse in `_build_parser()`
2. **Dispatch**: The `main()` function extracts the values and passes them to `cmd_flash()`
3. **Flash Command**: `cmd_flash()` (already had these parameters in its signature at lines 94-95)
4. **Chip Profile**: Parameters are mapped to chip-specific kwargs:
   - `no_stub` → `kwargs["no_stub"]` (line 252)
   - `extra_esptool_args` → `kwargs["extra_args"]` (line 254)
5. **Retry Logic**: Both parameters are preserved in retry scenarios (lines 487-490)

### Existing Support

The implementation found that `cmd_flash()` already had full support for both parameters:
- Parameter definitions in function signature (lines 94-95)
- Documentation in docstring (lines 113-114)
- Logic to pass them to chip profiles (lines 250-254)
- Preservation in retry logic (lines 487-490)

This task only needed to wire the CLI arguments to the existing implementation.

## Test Results

All tests pass successfully:
- **79 total tests** (63 in test_esp32_commands.py + 16 in test_preprocess_argv.py)
- New tests verify help output contains the expected flags
- Existing tests confirm no regression in functionality

### Test Coverage

The new CLI flags are tested at multiple levels:
1. **Help Output Tests** (new): Verify flags appear in `--help`
2. **Chip Profile Tests** (existing): Verify `extra_args` and `no_stub` behavior at ESP32Profile level
3. **Integration Tests** (existing): Verify overall flash command generation

## Usage Examples

### Using --no-stub
```bash
eabctl flash /path/to/firmware.bin --chip esp32c6 --no-stub
```

### Using --extra-esptool-args
```bash
eabctl flash /path/to/firmware.bin --chip esp32c6 --extra-esptool-args --no-compress --verify
```

### Combined Usage
```bash
eabctl flash /path/to/firmware.bin --chip esp32c6 --no-stub --extra-esptool-args --no-compress --verify
```

## Verification

Manual verification confirms the help output displays correctly:

```
  --no-stub             ESP32: Use ROM bootloader directly (slower but more
                        reliable for USB-JTAG)
  --extra-esptool-args [EXTRA_ESPTOOL_ARGS ...]
                        ESP32: Extra arguments to pass through to esptool
                        (e.g., --no-compress --verify)
```

## Conclusion

The task has been completed successfully with:
- ✅ CLI flags added to parser
- ✅ Parameters wired through main() dispatch
- ✅ Tests added and passing
- ✅ Help text properly formatted
- ✅ No regressions in existing tests
- ✅ Full integration with existing implementation
