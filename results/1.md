# Task Completion Report: Issue #77 - Refactor ZEPHYR_BASE Resolution

## Summary

Successfully added a `_resolve_zephyr_base()` static method to `ZephyrProfile` in `eab/chips/zephyr.py` that encapsulates the two-step ZEPHYR_BASE resolution pattern, eliminating code duplication in both `get_flash_command` and `get_flash_commands` methods.

## Changes Made

### 1. Added `_resolve_zephyr_base()` Static Method

**File**: `eab/chips/zephyr.py`

Added a new static method at line 423 that encapsulates the ZEPHYR_BASE resolution logic:

```python
@staticmethod
def _resolve_zephyr_base(build_path: Path) -> str | None:
    """Resolve ZEPHYR_BASE from workspace or CMakeCache.txt.

    Two-step resolution:
    1. Try to find workspace root (contains `.west/`) and derive `workspace/zephyr`
    2. If no workspace found, fall back to reading ZEPHYR_BASE from CMakeCache.txt

    This handles both in-tree builds (within Zephyr workspace) and out-of-tree
    builds (e.g., `west build --build-dir /tmp/build-nrf5340`).

    Args:
        build_path: Path to the Zephyr build directory.

    Returns:
        String path to ZEPHYR_BASE directory, or None if not resolvable.
    """
    # Try workspace detection first
    workspace = ZephyrProfile._find_workspace(build_path)
    if workspace:
        return str(workspace / "zephyr")
    
    # Fallback: read from CMakeCache.txt
    zephyr_base = ZephyrProfile._read_zephyr_base_from_cmake(build_path)
    if zephyr_base:
        return str(zephyr_base)
    
    return None
```

### 2. Updated `get_flash_command()` Method

**File**: `eab/chips/zephyr.py` (lines ~257-263)

Replaced the duplicated if/else pattern:

**Before** (9 lines):
```python
workspace = self._find_workspace(build_path)
if workspace:
    env["ZEPHYR_BASE"] = str(workspace / "zephyr")
else:
    # Fallback: read ZEPHYR_BASE from CMakeCache.txt in the build dir.
    # This handles out-of-tree builds (e.g., west build --build-dir /tmp/build).
    zephyr_base = self._read_zephyr_base_from_cmake(build_path)
    if zephyr_base:
        env["ZEPHYR_BASE"] = str(zephyr_base)
```

**After** (3 lines):
```python
zb = self._resolve_zephyr_base(build_path)
if zb:
    env["ZEPHYR_BASE"] = zb
```

### 3. Updated `get_flash_commands()` Method

**File**: `eab/chips/zephyr.py` (lines ~335-338)

Replaced the duplicated if/else pattern for NET core:

**Before** (7 lines):
```python
workspace = self._find_workspace(net_build_path)
if workspace:
    env["ZEPHYR_BASE"] = str(workspace / "zephyr")
else:
    zephyr_base = self._read_zephyr_base_from_cmake(net_build_path)
    if zephyr_base:
        env["ZEPHYR_BASE"] = str(zephyr_base)
```

**After** (3 lines):
```python
zb = self._resolve_zephyr_base(net_build_path)
if zb:
    env["ZEPHYR_BASE"] = zb
```

### 4. Added Unit Tests

**File**: `eab/tests/test_zephyr_profile.py`

Added 4 comprehensive tests for `_resolve_zephyr_base()`:

1. **`test_resolve_zephyr_base_workspace_exists`**: Verifies that the method returns `workspace/zephyr` when `.west/` directory exists above the build path.

2. **`test_resolve_zephyr_base_cmake_cache_fallback`**: Verifies that the method returns ZEPHYR_BASE from CMakeCache.txt when `.west/` is not found but CMakeCache.txt exists with a valid ZEPHYR_BASE entry.

3. **`test_resolve_zephyr_base_neither_exists`**: Verifies that the method returns None when neither `.west/` directory nor CMakeCache.txt with ZEPHYR_BASE exists.

4. **`test_resolve_zephyr_base_invalid_cmake_path`**: Verifies that the method returns None when CMakeCache.txt contains a ZEPHYR_BASE path that doesn't exist.

**File**: `eab/tests/test_zephyr_dual_core.py`

Added 1 test for dual-core out-of-tree scenario:

1. **`test_get_flash_commands_dual_core_out_of_tree_with_cmake`**: Verifies that both APP and NET build directories in `/tmp/` (out-of-tree) with CMakeCache.txt containing valid ZEPHYR_BASE paths correctly get `ZEPHYR_BASE` set in their environment variables.

## Test Results

All tests pass successfully:

- **`eab/tests/test_zephyr_profile.py`**: 68 tests passed (including 4 new tests)
- **`eab/tests/test_zephyr_dual_core.py`**: 15 tests passed (including 1 new test)
- **All Zephyr-related tests**: 86 tests passed

## Benefits

1. **Eliminated Code Duplication**: Removed two instances of the same 7-9 line if/else pattern, replacing them with a clean 3-line pattern.

2. **Improved Maintainability**: ZEPHYR_BASE resolution logic is now in one place, making it easier to maintain and modify.

3. **Better Separation of Concerns**: The new method has a single, clear responsibility.

4. **Enhanced Testability**: The static method can be tested independently, with comprehensive test coverage.

5. **Cleaner Code**: The calling code is more concise and readable.

## Files Modified

1. `eab/chips/zephyr.py` - Added method and updated two call sites
2. `eab/tests/test_zephyr_profile.py` - Added 4 unit tests
3. `eab/tests/test_zephyr_dual_core.py` - Added 1 integration test

## Verification

The changes were verified by:
- Running all existing tests to ensure no regressions
- Running new tests to verify the new functionality
- Confirming that all 86 Zephyr-related tests pass
