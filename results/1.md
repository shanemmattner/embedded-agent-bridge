# ESP32 Command Updates - Migration to Non-Deprecated Esptool Forms

## Summary

Updated `eab/chips/esp32.py` to use modern esptool command syntax, replacing deprecated underscore-based arguments with dash-based forms and `esptool.py` with `esptool`.

## Changes Made

### 1. Updated `flash_tool` Property (Line 204)
- **Before**: `return "esptool.py"`
- **After**: `return "esptool"`

### 2. Updated `get_flash_command` Method
- **Line 315**: `"default_reset"` → `"default-reset"`
- **Line 326**: `"hard_reset"` → `"hard-reset"`
- **Line 327**: `"write_flash"` → `"write-flash"`
- **Line 328**: `"--flash_mode"` → `"--flash-mode"`
- **Line 329**: `"--flash_size"` → `"--flash-size"`
- **Line 353**: `tool="esptool.py"` → `tool="esptool"`

### 3. Updated `get_erase_command` Method
- **Line 363**: `tool="esptool.py"` → `tool="esptool"`
- **Line 367**: `"erase_flash"` → `"erase-flash"`

### 4. Updated `get_chip_info_command` Method
- **Line 375**: `tool="esptool.py"` → `tool="esptool"`
- **Line 376**: `"chip_id"` → `"chip-id"`

## Test Coverage

Created comprehensive test suite in `eab/tests/test_esp32_commands.py` with **58 tests** covering:

### Core Functionality Tests
- ESP32 chip profile basic properties (family, name, patterns)
- Flash tool property returns `"esptool"` (not deprecated `"esptool.py"`)
- All command builders use dash-form arguments
- No deprecated underscore forms are present

### Flash Command Tests (21 tests)
- Tool name is `"esptool"`
- All arguments use dash form: `--flash-mode`, `--flash-size`, `write-flash`, `hard-reset`, `default-reset`
- USB-JTAG port detection and appropriate reset mode selection
- Command includes chip, port, baud, firmware path, address
- Default address is `0x10000`
- `--no-stub` flag and timeout behavior
- Flash mode and size arguments

### Erase Command Tests (5 tests)
- Tool name is `"esptool"`
- Uses `erase-flash` (not deprecated `erase_flash`)
- Includes chip and port arguments
- Proper timeout setting

### Chip Info Command Tests (3 tests)
- Tool name is `"esptool"`
- Uses `chip-id` (not deprecated `chip_id`)
- Includes port argument
- Proper timeout setting

### Additional Tests
- OpenOCD configuration for all ESP32 variants
- Reset sequences (hard, soft, bootloader)
- USB-JTAG port detection (macOS, Linux)
- Chip profile registry lookup
- Error pattern definitions
- Reset reason and boot mode parsing
- Flash args file parsing for multi-partition flashing
- CLI command integration tests

## Test Results

All 58 tests pass successfully:

```
============================= test session starts ==============================
platform darwin -- Python 3.14.3, pytest-9.0.2, pluggy-1.6.0
eab/tests/test_esp32_commands.py::58 tests PASSED [100%]
============================== 58 passed in 0.30s ===============================
```

## Verification

### No Deprecated Forms Remain
Verified that no deprecated underscore forms remain in command arguments:
```bash
grep -E '(default_reset|hard_reset|write_flash|--flash_mode|--flash_size|erase_flash|chip_id)' eab/chips/esp32.py
# Returns no matches (except in comments/docstrings)
```

### All Commands Use Modern Forms
- `esptool` (not `esptool.py`)
- `default-reset` (not `default_reset`)
- `hard-reset` (not `hard_reset`)
- `write-flash` (not `write_flash`)
- `--flash-mode` (not `--flash_mode`)
- `--flash-size` (not `--flash_size`)
- `erase-flash` (not `erase_flash`)
- `chip-id` (not `chip_id`)

## Files Modified

1. **eab/chips/esp32.py** - Updated command builders to use non-deprecated forms
2. **eab/tests/test_esp32_commands.py** (NEW) - Comprehensive test suite with 58 tests

## Backward Compatibility

Modern esptool versions support both forms, but the dash-based forms are the official, non-deprecated syntax. These changes align with esptool best practices and future-proof the codebase against potential removal of deprecated forms.
