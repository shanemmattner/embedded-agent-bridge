# ESP-IDF Project Detection Implementation

## Summary

Successfully implemented ESP-IDF project detection and chip auto-detection functionality for the Embedded Agent Bridge (EAB) project.

## Changes Made

### 1. Core Implementation (`eab/chips/esp32.py`)

Added two static methods to the `ESP32Profile` class:

#### `detect_chip_from_sdkconfig(project_dir: Path) -> str | None`

- Detects chip variant from `sdkconfig` or `sdkconfig.defaults` files
- Parses `CONFIG_IDF_TARGET` configuration value
- Handles both quoted and unquoted values
- Returns chip string (e.g., "esp32c6") or None if not found
- Includes error handling for unreadable files

#### `detect_esp_idf_project(path: str) -> dict | None`

- Detects if a directory is an ESP-IDF project
- Checks for multiple ESP-IDF project markers:
  - `sdkconfig` or `sdkconfig.defaults` files
  - `CMakeLists.txt` with ESP-IDF specific functions (`idf_component_register`, `project()`, `IDF_PATH`)
  - `build/flash_args` for built projects
- Returns a dict with project information:
  ```python
  {
      "chip": "esp32c6",           # Chip variant from sdkconfig
      "build_dir": "/path/build",  # Build directory path
      "has_flash_args": True       # Whether flash_args exists (project is built)
  }
  ```
- Returns `None` if path is not an ESP-IDF project
- Requires at least one `sdkconfig` file for ESP-IDF detection

### 2. New Test File (`eab/tests/test_esp32_project_detect.py`)

Created comprehensive unit tests with 23 test cases covering:

- **Chip detection tests** (8 tests):
  - Detection with quoted and unquoted values
  - Fallback to `sdkconfig.defaults`
  - Preference for `sdkconfig` over defaults
  - Missing files and target handling
  - Whitespace handling
  - Various ESP32 chip variants

- **Project detection tests** (15 tests):
  - Valid projects with and without build directories
  - Projects with `sdkconfig` vs `sdkconfig.defaults`
  - Detection via different CMakeLists.txt markers
  - Non-ESP-IDF directories
  - Empty and nonexistent paths
  - Realistic project structures
  - Error handling for unreadable files

### 3. Updated Existing Tests (`eab/tests/test_esp32_project_flash.py`)

Updated 13 existing tests to work with the new dict-based API:

- Fixed return value unpacking from tuple to dict
- Updated assertions to use dict keys
- Maintained test coverage for flash command integration
- All tests now pass successfully

## Test Results

All 41 ESP32-related tests pass:
- 23 new tests in `test_esp32_project_detect.py`
- 13 updated tests in `test_esp32_project_flash.py`
- 5 other ESP32 pattern/profile tests

```
=================== 41 passed, 236 deselected, 2 warnings in 0.07s ===================
```

## Manual Verification

Tested against real ESP-IDF project (`examples/esp32c6-test-firmware`):
- Successfully detects chip variant: "esp32c6"
- Correctly identifies project structure
- Handles missing build directory appropriately

## Design Decisions

1. **Dict return value**: Chosen over tuple for better extensibility and clarity
2. **Requires sdkconfig**: At least one sdkconfig file is required for ESP-IDF detection to avoid false positives
3. **Multiple detection methods**: Supports various ESP-IDF project layouts (with/without build, different CMakeLists.txt patterns)
4. **Graceful error handling**: Returns None instead of raising exceptions for better integration with calling code

## Compatibility

The implementation integrates seamlessly with the existing `eab/cli/flash_cmds.py` which already expects the dict-based return format. This enables automatic chip detection when flashing ESP-IDF projects without requiring the `--chip` flag.
