# Board-Name-to-Architecture Mapping Implementation

## Summary

Successfully implemented board-name-to-architecture mapping in `ZephyrProfile` to properly detect chip families from board names when variant information is absent or unrecognized. This fixes the issue where MCX variants and unknown boards were incorrectly defaulting to `ChipFamily.NRF52`.

## Changes Made

### 1. Added `ChipFamily.MCX` Enum Value (`eab/chips/base.py`)

```python
class ChipFamily(Enum):
    """Supported chip families."""
    ESP32 = "esp32"
    STM32 = "stm32"
    NRF52 = "nrf52"
    RP2040 = "rp2040"
    MCX = "mcx"  # NXP MCX series (MCXN947, etc.)
    ZEPHYR = "zephyr"  # Zephyr RTOS (arch unknown) - already present
```

This ensures MCX chips are properly classified instead of being misidentified as NRF52. Note: `ChipFamily.ZEPHYR` was already present in the codebase from a previous change.

### 2. Created `BOARD_ARCH_MAP` (`eab/chips/zephyr.py`)

Added a comprehensive mapping of board name patterns to `ChipFamily` values:

```python
BOARD_ARCH_MAP: dict[str, ChipFamily] = {
    # ESP32 boards
    "esp32": ChipFamily.ESP32,
    "esp32s2": ChipFamily.ESP32,
    "esp32s3": ChipFamily.ESP32,
    "esp32c3": ChipFamily.ESP32,
    "esp32c6": ChipFamily.ESP32,
    
    # STM32 boards
    "nucleo": ChipFamily.STM32,
    "stm32": ChipFamily.STM32,
    "disco": ChipFamily.STM32,
    "stm32f4": ChipFamily.STM32,
    "stm32f7": ChipFamily.STM32,
    "stm32h7": ChipFamily.STM32,
    "stm32l4": ChipFamily.STM32,
    "stm32g4": ChipFamily.STM32,
    
    # RP2040 boards
    "rpi_pico": ChipFamily.RP2040,
    "rp2040": ChipFamily.RP2040,
    "pico": ChipFamily.RP2040,
    
    # Nordic boards
    "nrf52": ChipFamily.NRF52,
    "nrf53": ChipFamily.NRF52,
    "nrf91": ChipFamily.NRF52,
    
    # NXP MCX boards
    "frdm_mcx": ChipFamily.MCX,
    "mcx": ChipFamily.MCX,
    "mcxn947": ChipFamily.MCX,
    "mcxa": ChipFamily.MCX,
    "mcxw": ChipFamily.MCX,
}
```

### 3. Updated `BOARD_DEFAULTS` with Architecture Hints

Added `"arch"` key to all entries in `BOARD_DEFAULTS`:

```python
BOARD_DEFAULTS: dict[str, dict[str, str | None | ChipFamily]] = {
    "nrf5340": {"board": "nrf5340dk/nrf5340/cpuapp", "runner": "jlink", "arch": ChipFamily.NRF52},
    "nrf52840": {"board": "nrf52840dk/nrf52840", "runner": "jlink", "arch": ChipFamily.NRF52},
    "nrf52833": {"board": "nrf52833dk/nrf52833", "runner": "jlink", "arch": ChipFamily.NRF52},
    "rp2040": {"board": "rpi_pico", "runner": None, "arch": ChipFamily.RP2040},
    "mcxn947": {"board": "frdm_mcxn947/mcxn947/cpu0", "runner": "linkserver", "arch": ChipFamily.MCX},
}
```

### 4. Enhanced `family` Property with Multi-Step Detection

Updated the `family` property to use a 4-step detection process:

1. **Check variant first** (existing logic) - Maps variant strings like "nrf5340", "esp32", "stm32", "rp2040", "mcx" to their families
2. **Check board name** against `BOARD_ARCH_MAP` - When variant is None/unrecognized, searches board name for known patterns
3. **Check `BOARD_DEFAULTS`** for arch hints - Looks up variant in BOARD_DEFAULTS and uses the 'arch' key if present
4. **Default fallback** - Returns `ChipFamily.NRF52` as a sensible default

This ensures proper architecture detection even when variant information is incomplete or missing.

### 5. Added `detect_arch_from_build()` Method

Created a new method that reads the BOARD value from `CMakeCache.txt` and infers the architecture:

```python
def detect_arch_from_build(self, build_dir: str | Path) -> ChipFamily | None:
    """
    Detect chip architecture from CMakeCache.txt in build directory.
    
    Reads the BOARD value from CMakeCache.txt and infers the architecture
    using the same logic as the family property.
    """
    board = self.detect_board_from_build(build_dir)
    if not board:
        return None
    
    # Create a temporary profile with the detected board to infer architecture
    temp_profile = ZephyrProfile(variant=None, board=board)
    return temp_profile.family
```

This reuses the existing `detect_board_from_build()` method and leverages the new `family` property logic.

## Tests Added

Added 20 comprehensive tests covering:

### Board Name Detection Tests
- `test_family_from_board_esp32` - ESP32 board name patterns (esp32_devkitc, esp32s3_devkitm, esp32c6_devkitc)
- `test_family_from_board_stm32` - STM32 board patterns (nucleo_f429zi, stm32f407_disco, disco_l475_iot1)
- `test_family_from_board_rp2040` - RP2040 board patterns (rpi_pico, pico_w)
- `test_family_from_board_nrf` - Nordic board patterns (nrf52840dk, nrf5340dk)
- `test_family_from_board_mcx` - NXP MCX board patterns (frdm_mcxn947, mcxn947dk, frdm_mcxa153)

### Variant Detection Tests
- `test_family_from_variant_mcx` - MCX variant string detection

### Edge Cases
- `test_family_unknown_board_default` - Unknown boards default to NRF52
- `test_family_variant_overrides_board` - Variant takes precedence over board name
- `test_family_board_defaults_arch_key` - All BOARD_DEFAULTS have 'arch' key
- `test_family_from_board_defaults` - Architecture from BOARD_DEFAULTS fallback
- `test_family_case_insensitive_board_matching` - Case-insensitive board name matching

### CMakeCache Detection Tests
- `test_detect_arch_from_build_esp32` - ESP32 detection from CMakeCache.txt
- `test_detect_arch_from_build_stm32` - STM32 detection from CMakeCache.txt
- `test_detect_arch_from_build_rp2040` - RP2040 detection from CMakeCache.txt
- `test_detect_arch_from_build_nrf` - nRF detection from CMakeCache.txt
- `test_detect_arch_from_build_mcx` - MCX detection from CMakeCache.txt
- `test_detect_arch_from_build_unknown_board` - Unknown board defaults to NRF52
- `test_detect_arch_from_build_missing_cmake` - Returns None when CMakeCache.txt missing
- `test_detect_arch_from_build_no_board_line` - Returns None when BOARD line missing

### Completeness Tests
- `test_board_arch_map_completeness` - All ChipFamily values represented in map

## Test Results

All 107 tests in `test_zephyr_profile.py` pass:
- 87 existing tests continue to pass (no regressions)
- 20 new tests added for board-to-architecture mapping

```
============================= 107 passed in 0.04s =============================
```

All chip-related tests (139 total) pass across the entire test suite.

## Behavior Examples

### Before (Incorrect)
```python
# MCX variant defaulted to NRF52 (wrong!)
profile = ZephyrProfile(variant="mcxn947")
assert profile.family == ChipFamily.NRF52  # ❌ WRONG

# Unknown boards defaulted to NRF52 even with clear board names
profile = ZephyrProfile(variant=None, board="esp32_devkitc")
assert profile.family == ChipFamily.NRF52  # ❌ WRONG
```

### After (Correct)
```python
# MCX variant correctly identified
profile = ZephyrProfile(variant="mcxn947")
assert profile.family == ChipFamily.MCX  # ✅ CORRECT

# Board names properly detected
profile = ZephyrProfile(variant=None, board="esp32_devkitc")
assert profile.family == ChipFamily.ESP32  # ✅ CORRECT

profile = ZephyrProfile(variant=None, board="frdm_mcxn947/mcxn947/cpu0")
assert profile.family == ChipFamily.MCX  # ✅ CORRECT

profile = ZephyrProfile(variant=None, board="nucleo_f429zi")
assert profile.family == ChipFamily.STM32  # ✅ CORRECT
```

### CMakeCache Detection
```python
# Auto-detect from build directory
profile = ZephyrProfile()
arch = profile.detect_arch_from_build("/path/to/build")
# Reads CMakeCache.txt, extracts BOARD, and infers architecture
```

## Files Modified

1. `eab/chips/base.py` - Added `ChipFamily.MCX` enum value (note: `ChipFamily.ZEPHYR` was already present from prior work)
2. `eab/chips/zephyr.py` - Added `BOARD_ARCH_MAP`, updated `BOARD_DEFAULTS`, enhanced `family` property, added `detect_arch_from_build()` method
3. `eab/tests/test_zephyr_profile.py` - Added 20 comprehensive tests for board-to-architecture mapping
4. `eab/chips/__init__.py` - Pre-existing changes to `detect_chip_family()` already present in working tree (reordered chip detection to check specific chips before Zephyr RTOS detection)

## Design Decisions

1. **Pattern Matching**: Used substring matching for board names (case-insensitive) to handle various board naming conventions
2. **Precedence Order**: Variant > Board > BOARD_DEFAULTS > Default fallback
3. **Default Fallback**: Kept NRF52 as default since Zephyr is commonly used with Nordic chips
4. **Reuse**: `detect_arch_from_build()` reuses existing `detect_board_from_build()` and `family` property logic
5. **Type Safety**: Added `ChipFamily` type hint to BOARD_DEFAULTS 'arch' values

## Impact

- ✅ MCX variants no longer misclassified as NRF52
- ✅ Board names can now determine architecture independently of variant
- ✅ CMakeCache.txt can be used to auto-detect architecture from build directories
- ✅ All existing functionality preserved (no breaking changes)
- ✅ Comprehensive test coverage for all code paths
