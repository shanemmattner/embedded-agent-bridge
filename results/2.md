# Issue #63: Fix detect_chip_family() for Zephyr on non-nRF targets

## Summary

Fixed `detect_chip_family()` in `eab/chips/__init__.py` to properly handle Zephyr RTOS on non-nRF targets. Previously, any Zephyr boot message was hardcoded to return `ChipFamily.NRF52`, which misclassified Zephyr on ESP32, STM32, RP2040, and other targets.

## Changes Made

### 1. Added `ChipFamily.ZEPHYR` Enum Value
**File:** `eab/chips/base.py`
- Added `ZEPHYR = "zephyr"` to the `ChipFamily` enum
- Represents "Zephyr RTOS detected but specific architecture unknown"

### 2. Reordered Detection Logic in `detect_chip_family()`
**File:** `eab/chips/__init__.py` (lines 103-153)

**Before:** Zephyr check was first, causing all Zephyr lines to return `NRF52`
```python
# Zephyr detection (before chip-specific checks)  ❌ WRONG ORDER
# TODO(#63): Zephyr is cross-platform — this defaults to NRF52...
zephyr_indicators = ["booting zephyr", "zephyr version", "zephyr fatal error"]
if any(ind in line_lower for ind in zephyr_indicators):
    return ChipFamily.NRF52

# ESP32 detection patterns
...
```

**After:** Chip-specific checks first, Zephyr check last
```python
# ESP32 detection patterns (check BEFORE Zephyr to catch ESP32+Zephyr)
esp32_indicators = [...]
if any(ind in line_lower for ind in esp32_indicators):
    return ChipFamily.ESP32

# STM32 detection patterns (check BEFORE Zephyr to catch STM32+Zephyr)
...

# nRF52 detection (check BEFORE Zephyr to catch nRF+Zephyr)
...

# Zephyr detection (AFTER chip-specific checks)
# If we see Zephyr but no chip-specific indicators, return ZEPHYR sentinel
zephyr_indicators = ["booting zephyr", "zephyr version", "zephyr fatal error"]
if any(ind in line_lower for ind in zephyr_indicators):
    return ChipFamily.ZEPHYR
```

### 3. Removed TODO Comment
Deleted the `TODO(#63)` comment as the issue is now resolved.

### 4. Updated Tests
**File:** `eab/tests/test_zephyr_profile.py`

**Updated existing tests** to expect `ChipFamily.ZEPHYR` instead of `ChipFamily.NRF52`:
- `test_detect_chip_family_booting_zephyr`
- `test_detect_chip_family_zephyr_version`
- `test_detect_chip_family_zephyr_fatal_error`

**Added new tests** to verify chip-specific indicators take priority:
- `test_detect_chip_family_zephyr_esp32` - Verifies "Booting Zephyr OS on ESP32-C6" returns `ESP32`
- `test_detect_chip_family_zephyr_nrf` - Verifies "Booting Zephyr on nRF5340" returns `NRF52`
- `test_detect_chip_family_zephyr_stm32` - Verifies "Zephyr on STM32F4" returns `STM32`

## Behavior Changes

| Input Line | Old Behavior | New Behavior | Correct? |
|------------|--------------|--------------|----------|
| `*** Booting Zephyr OS build v3.5.0 ***` | `NRF52` ❌ | `ZEPHYR` ✅ | Yes - arch unknown |
| `*** Booting Zephyr OS on ESP32-C6 ***` | `NRF52` ❌ | `ESP32` ✅ | Yes - ESP32 detected |
| `Booting Zephyr on nRF5340` | `NRF52` ✅ | `NRF52` ✅ | Yes - nRF detected |
| `Zephyr on STM32F4 Discovery` | `NRF52` ❌ | `STM32` ✅ | Yes - STM32 detected |
| `ESP-IDF v5.2 bootloader` | `ESP32` ✅ | `ESP32` ✅ | Yes - unchanged |

## Downstream Impact Analysis

### ✅ No Breaking Changes
The `ChipFamily.ZEPHYR` sentinel is only returned when **no chip-specific indicators** are present. When chip-specific content exists (ESP32, STM32, nRF keywords), those families are returned as before.

### Checked Downstream Consumers

1. **`zephyr.py:254`** - `if self.family == ChipFamily.ESP32 and port:`
   - ✅ Safe: This checks `ZephyrProfile.family` (a property), not `detect_chip_family()` result
   - No profile returns `ChipFamily.ZEPHYR` from the `family` property

2. **Pattern matchers and fault decoders**
   - ✅ Safe: These use profile-specific patterns, not the detection enum

3. **Profile registry (`_PROFILES` dict)**
   - ✅ Safe: No profile registered for `"zephyr"` enum value

## Test Results

```
$ pytest eab/tests/test_zephyr_profile.py -v
============================= 87 passed =============================

$ pytest eab/tests/test_esp32_commands.py eab/tests/test_stm32_commands.py -k "not gdb" -v
============================= 103 passed =============================
```

All tests pass, including:
- 3 updated Zephyr detection tests
- 3 new chip-priority tests
- All existing chip profile tests

## Manual Validation

```python
from eab.chips import detect_chip_family
from eab.chips.base import ChipFamily

# Pure Zephyr → ZEPHYR (arch unknown)
assert detect_chip_family('*** Booting Zephyr OS ***') == ChipFamily.ZEPHYR

# Chip-specific indicators take priority over Zephyr
assert detect_chip_family('Booting Zephyr on ESP32-C6') == ChipFamily.ESP32
assert detect_chip_family('Booting Zephyr on nRF5340') == ChipFamily.NRF52
assert detect_chip_family('Zephyr on STM32F4') == ChipFamily.STM32
```

All manual tests passed ✅

## Conclusion

The fix correctly implements the requirements from issue #63:
1. ✅ Chip-specific indicators checked BEFORE Zephyr check
2. ✅ Pure Zephyr lines return `ChipFamily.ZEPHYR` sentinel
3. ✅ Downstream consumers handle new enum gracefully (no breaking changes)
4. ✅ TODO comment removed
5. ✅ Tests updated and new tests added to verify behavior
