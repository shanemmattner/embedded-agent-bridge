# Task Complete: ESP-IDF Project Directory Support

## Summary

Successfully updated `eabctl flash` to support ESP-IDF project directories with automatic chip detection. The implementation leverages the existing `ESP32Profile.detect_esp_idf_project()` method which was already in the codebase.

## Changes Made

### 1. CLI Argument Parsing (`eab/cli/__init__.py`)

**Changed:**
- `firmware` argument help text: `"Path to firmware binary (.bin/.hex/.elf) or ESP-IDF project directory"`
- `--chip` flag: Made optional (`required=False, default=None`)

### 2. Flash Command Logic (`eab/cli/flash_cmds.py`)

**Added ESP-IDF project detection logic:**
- Checks if `firmware` path is a directory
- Calls `ESP32Profile.detect_esp_idf_project()` to analyze the directory
- Returns helpful errors for:
  - Unbuilt projects: "ESP-IDF project not built. Run 'idf.py build' first."
  - Non-ESP directories: "Directory is not an ESP-IDF project (no sdkconfig or build/flash_args found)"
  - Binary files without --chip: "--chip is required when flashing a binary file"
- Auto-detects chip from `sdkconfig` when `--chip` is not provided
- Allows explicit `--chip` to override auto-detection

### 3. Tests (`eab/tests/test_esp32_project_flash.py`)

**Created comprehensive test suite with 13 tests:**

1. `test_detect_esp_idf_project_with_valid_built_project` - Valid project detection
2. `test_detect_esp_idf_project_with_unbuilt_project` - Unbuilt project detection
3. `test_detect_esp_idf_project_with_non_esp_directory` - Non-ESP directory detection
4. `test_detect_esp_idf_project_with_different_chip_types` - Multiple chip types (esp32, esp32s3, esp32c6, etc.)
5. `test_cmd_flash_with_esp_idf_project_auto_detects_chip` - Auto-detection end-to-end
6. `test_cmd_flash_with_esp_idf_project_explicit_chip_override` - Explicit --chip override
7. `test_cmd_flash_with_unbuilt_project_returns_error` - Error handling for unbuilt projects
8. `test_cmd_flash_with_non_esp_directory_returns_error` - Error handling for non-ESP directories
9. `test_cmd_flash_with_binary_file_no_chip_returns_error` - Require --chip for binaries
10. `test_cmd_flash_with_binary_file_and_chip_still_works` - Backward compatibility
11. `test_detect_esp_idf_project_with_sdkconfig_without_quotes` - Config parsing variants
12. `test_detect_esp_idf_project_with_build_only_no_sdkconfig` - Edge case validation
13. `test_cmd_flash_with_esp_project_no_sdkconfig_requires_explicit_chip` - Missing chip info handling

**All tests verify real behavior with:**
- Mock subprocess execution
- JSON output validation
- Command argument inspection
- Error message verification

## Usage Examples

### Auto-detect chip from ESP-IDF project:
```bash
eabctl flash /path/to/esp-project --json
```

### Override auto-detected chip:
```bash
eabctl flash /path/to/esp-project --chip esp32s3 --json
```

### Backward compatible binary flashing:
```bash
eabctl flash firmware.bin --chip esp32c6 --json
```

### Error cases:
```bash
# Unbuilt project
eabctl flash /path/to/unbuilt-project --json
# Returns: {"error": "ESP-IDF project not built. Run 'idf.py build' first."}

# Non-ESP directory
eabctl flash /path/to/random-dir --json
# Returns: {"error": "Directory is not an ESP-IDF project..."}

# Binary without --chip
eabctl flash firmware.bin --json
# Returns: {"error": "--chip is required when flashing a binary file"}
```

## Test Results

All 13 new tests pass:
```
eab/tests/test_esp32_project_flash.py::test_detect_esp_idf_project_with_valid_built_project PASSED
eab/tests/test_esp32_project_flash.py::test_detect_esp_idf_project_with_unbuilt_project PASSED
eab/tests/test_esp32_project_flash.py::test_detect_esp_idf_project_with_non_esp_directory PASSED
eab/tests/test_esp32_project_flash.py::test_cmd_flash_with_esp_idf_project_auto_detects_chip PASSED
eab/tests/test_esp32_project_flash.py::test_cmd_flash_with_esp_idf_project_explicit_chip_override PASSED
eab/tests/test_esp32_project_flash.py::test_cmd_flash_with_unbuilt_project_returns_error PASSED
eab/tests/test_esp32_project_flash.py::test_cmd_flash_with_non_esp_directory_returns_error PASSED
eab/tests/test_esp32_project_flash.py::test_cmd_flash_with_binary_file_no_chip_returns_error PASSED
eab/tests/test_esp32_project_flash.py::test_cmd_flash_with_binary_file_and_chip_still_works PASSED
... (13/13 passed)
```

No existing tests were broken by these changes.

## Design Notes

1. **Reused existing functionality:** The implementation leverages `ESP32Profile.detect_esp_idf_project()` which was already in the codebase, ensuring consistency with existing logic.

2. **Backward compatibility:** Binary file flashing with explicit `--chip` still works exactly as before.

3. **Error messages:** All error messages are clear and actionable, telling users exactly what to do.

4. **Test coverage:** Tests cover all major paths including edge cases, error conditions, and backward compatibility.

5. **Minimal changes:** Only touched the necessary files, following the existing code patterns.
