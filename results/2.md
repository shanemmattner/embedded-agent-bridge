# Task 2: Enhance `_find_workspace` with CMakeCache fallback

## Summary

Enhanced the `_find_workspace` method in `eab/chips/zephyr.py` to accept an optional `build_path` parameter. After the directory-walk loop fails to find a `.west/` directory, the method now attempts to derive the workspace root from `ZEPHYR_BASE` in `CMakeCache.txt`.

## Changes Made

### 1. Modified `_find_workspace` method (line 417)

**Before:**
```python
@staticmethod
def _find_workspace(start: Path) -> Path | None:
```

**After:**
```python
@staticmethod
def _find_workspace(start: Path, build_path: Path | None = None) -> Path | None:
```

**Implementation:**
- Added `build_path: Path | None = None` parameter
- After directory-walk loop returns None (line 432), added fallback logic:
  1. Check if `build_path` is provided
  2. Read `ZEPHYR_BASE:PATH` from `CMakeCache.txt` using `_read_zephyr_base_from_cmake`
  3. Derive workspace root as `zephyr_base.parent`
  4. Validate by checking `(zephyr_base.parent / '.west').is_dir()`
  5. Return `zephyr_base.parent` if `.west/` exists, else None

### 2. Updated calls to `_find_workspace`

Updated three call sites to pass the `build_path` parameter:

1. **`get_flash_command` (line 260):**
   ```python
   workspace = self._find_workspace(build_path, build_path=build_path)
   ```

2. **`get_flash_commands` for NET core (line 343):**
   ```python
   workspace = self._find_workspace(net_build_path, build_path=net_build_path)
   ```

3. **`_resolve_zephyr_base` (line 460):**
   ```python
   workspace = ZephyrProfile._find_workspace(build_path, build_path=build_path)
   ```

### 3. Added comprehensive tests

Added two new tests in `eab/tests/test_zephyr_profile.py`:

#### `test_zephyr_find_workspace_via_cmake_cache`
- Creates a workspace with `.west/` and `zephyr/` directories
- Creates a separate out-of-tree build directory with `CMakeCache.txt`
- CMakeCache points `ZEPHYR_BASE` to workspace's zephyr directory
- Verifies `_find_workspace(out_of_tree_build, build_path=out_of_tree_build)` returns the workspace root
- Uses `.resolve()` on both sides to handle macOS symlinks (`/var` → `/private/var`)

#### `test_zephyr_find_workspace_via_cmake_cache_no_west`
- Creates a zephyr directory WITHOUT `.west/` at parent
- Creates an out-of-tree build directory with CMakeCache pointing to that zephyr dir
- Verifies `_find_workspace` returns None (since `.west/` doesn't exist at parent)
- This ensures the method doesn't return invalid workspace paths

## Test Results

All 70 tests pass:
```
============================== 70 passed in 0.07s ==============================
```

Key tests:
- ✅ `test_zephyr_find_workspace_via_cmake_cache` - Positive case
- ✅ `test_zephyr_find_workspace_via_cmake_cache_no_west` - Negative case
- ✅ All existing `_find_workspace` tests still pass
- ✅ All existing `get_flash_command` tests still pass
- ✅ All `_resolve_zephyr_base` tests still pass

## Behavior

The enhanced `_find_workspace` method now supports three resolution paths:

1. **In-tree builds:** Directory walk finds `.west/` → returns workspace root
2. **Out-of-tree builds with workspace:** Directory walk fails → reads CMakeCache → finds ZEPHYR_BASE → validates `.west/` at parent → returns workspace root
3. **Pure ZEPHYR_BASE without workspace:** Directory walk fails → reads CMakeCache → no `.west/` at parent → returns None (handled by `_resolve_zephyr_base`)

This maintains backward compatibility while adding support for out-of-tree builds where the build directory is outside the workspace but CMakeCache contains a valid ZEPHYR_BASE pointing to a workspace.
