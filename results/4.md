# Implementation: Zephyr/nRF/MCX Reset Support

## Summary

Successfully implemented reset command support for Zephyr/nRF/MCX targets in `eabctl reset`. The implementation adds three reset strategies:
1. **nRF targets**: Use `nrfjprog --reset` (Nordic's official tool)
2. **MCXN947**: Use OpenOCD with CMSIS-DAP interface
3. **Generic J-Link fallback**: Generate temporary J-Link Commander script for other targets

## Changes Made

### 1. Added `get_reset_command()` to `ZephyrProfile` (`eab/chips/zephyr.py`)

**Location**: Lines 392-478

**Implementation**:
- **nRF variants** (nrf5340, nrf52840, nrf52833): Returns `nrfjprog --reset` command
- **MCXN947**: Returns OpenOCD command with inline CMSIS-DAP configuration and `reset run` TCL command
- **Generic fallback**: Creates temporary J-Link script file with device connection and reset sequence when `--device` parameter provided
- **Error handling**: Raises `NotImplementedError` with helpful messages when reset not supported or device string missing

**Key features**:
- Automatic temp file creation for J-Link scripts (prefix: `jlink_reset_*.jlink`)
- 30-second timeout for all reset operations
- Proper error messages guiding users to provide `--device` or use alternative tools

### 2. Updated `cmd_reset()` in `eab/cli/flash_cmds.py`

**Changes**:
- Added `device` parameter for J-Link device string
- Added ZephyrProfile detection: checks if profile has `get_reset_command()` method
- Integrated reset command execution with proper error handling
- Added temp file cleanup for J-Link scripts (even on failure)
- Preserves existing STM32 reset functionality (st-flash and STM32CubeProgrammer)
- Returns exit code 2 for invalid chip types

**Error handling improvements**:
- Catches `NotImplementedError` and `ValueError` from `get_reset_command()`
- Handles subprocess timeouts and tool-not-found errors
- Provides informative JSON/human-readable output

### 3. Added `--device` argument to reset subparser (`eab/cli/__init__.py`)

**Changes**:
- Line 381: Added `--device` argument with help text
- Line 673: Updated `cmd_reset()` call to pass `device` parameter from args

### 4. Comprehensive Test Suite (`tests/test_zephyr_reset.py`)

**30 tests covering**:

#### ZephyrProfile.get_reset_command() Tests (9 tests)
- ✅ nRF5340/nRF52840/nRF52833 reset uses `nrfjprog`
- ✅ MCXN947 reset uses OpenOCD (ignores runner parameter)
- ✅ J-Link fallback creates script file with correct content
- ✅ J-Link fallback requires device string
- ✅ Temp file has correct prefix and extension

#### cmd_reset() Integration Tests (8 tests)
- ✅ Successful reset for nRF5340, nRF52840, MCXN947
- ✅ J-Link fallback with device string
- ✅ Tool-not-found error handling
- ✅ Timeout handling
- ✅ Invalid chip error handling
- ✅ STM32 backward compatibility preserved

#### CLI Argument Parsing Tests (4 tests)
- ✅ `--device` argument parsing
- ✅ Default values (device=None)
- ✅ `--method` and `--connect-under-reset` flags

#### CLI Integration Tests (3 tests)
- ✅ Reset via main() entry point for nRF5340, MCXN947, RP2040
- ✅ Device string passed through correctly

#### Edge Case Tests (6 tests)
- ✅ None variant handling
- ✅ Empty device string handling
- ✅ Timeout preservation
- ✅ Script creation failure handling
- ✅ Temp file cleanup on success/failure

## Test Results

```
============================= 416 passed in 1.82s ==============================
```

All tests pass, including:
- 30 new Zephyr reset tests
- 386 existing tests (no regressions)

## Usage Examples

### nRF5340 Reset
```bash
eabctl reset --chip nrf5340
# Uses: nrfjprog --reset
```

### nRF52840 Reset
```bash
eabctl reset --chip nrf52840
# Uses: nrfjprog --reset
```

### MCXN947 Reset
```bash
eabctl reset --chip mcxn947
# Uses: openocd -f interface/cmsis-dap.cfg ... -c "reset run" -c "shutdown"
```

### Generic J-Link Target (e.g., RP2040)
```bash
eabctl reset --chip rp2040 --device RP2040
# Creates temp J-Link script: /tmp/jlink_reset_XXXXXX.jlink
# Uses: JLinkExe -CommandFile <script>
```

### JSON Output
```bash
eabctl reset --chip nrf5340 --json
{
  "schema_version": 1,
  "timestamp": "2026-02-12T15:38:53",
  "success": true,
  "chip": "nrf5340",
  "method": "hard",
  "connect_under_reset": false,
  "retried_with_connect_under_reset": false,
  "command": ["nrfjprog", "--reset"],
  "stdout": "Resetting device...",
  "stderr": "",
  "duration_ms": 245
}
```

## Technical Details

### J-Link Script Format
When using generic J-Link fallback, the generated script contains:
```
connect
device <DEVICE_STRING>
si SWD
speed 4000
r
g
exit
```

Where:
- `r` = reset command
- `g` = go (resume execution)

### Cleanup Strategy
Temp files are tracked and cleaned up in a try/finally block equivalent pattern:
1. Script path extracted from command args if JLinkExe detected
2. Cleanup attempted after subprocess completes (success or failure)
3. Best-effort cleanup (exceptions silently caught)

### Error Messages
- **Missing device string**: "Reset not implemented for Zephyr variant 'rp2040'. Provide --device argument for J-Link reset, or use board-specific tools."
- **Invalid chip**: "Unsupported chip: xyz. Supported: esp32, mcxn947, nrf5340, nrf52840, nrf52833, rp2040, stm32, zephyr"
- **Tool not found**: "Tool not found: nrfjprog"
- **Timeout**: "Timeout after 30s"

## Backward Compatibility

✅ **STM32 reset unchanged**: Existing STM32 reset via `st-flash reset` and STM32CubeProgrammer still works exactly as before.

✅ **ESP32 still returns not implemented**: ESP32 reset still returns helpful error message directing users to OpenOCD commands.

✅ **All existing tests pass**: 386 existing tests continue to pass with no modifications needed.

## Code Quality

- **Follows existing patterns**: Uses `FlashCommand` dataclass, same subprocess error handling as flash/erase commands
- **Minimal changes**: Only touched files directly related to reset functionality
- **Well-tested**: 30 comprehensive tests covering success paths, error handling, and edge cases
- **Type hints**: All new code uses proper type annotations
- **Documentation**: Docstrings explain reset strategies and parameters

## Files Modified

1. `eab/chips/zephyr.py` - Added `get_reset_command()` method (87 lines)
2. `eab/cli/flash_cmds.py` - Updated `cmd_reset()` to support Zephyr (added ~60 lines)
3. `eab/cli/__init__.py` - Added `--device` argument and wired it through (2 lines)
4. `tests/test_zephyr_reset.py` - New comprehensive test suite (30 tests, 543 lines)

## Implementation Checklist

- ✅ Add `get_reset_command()` method to `ZephyrProfile`
- ✅ Implement nRF reset path using nrfjprog
- ✅ Implement MCXN947 reset path using OpenOCD
- ✅ Implement J-Link Commander fallback with temp script generation
- ✅ Wire reset logic into `cmd_reset()`
- ✅ Add `--device` argument to reset subparser
- ✅ Pass `--device` through main() dispatcher
- ✅ Add tests for nRF5340, nRF52840, MCXN947 reset
- ✅ Add tests for J-Link fallback behavior
- ✅ Add tests for argument parsing
- ✅ Add tests for CLI integration
- ✅ Add tests for edge cases and error handling
- ✅ Add tests for temp file cleanup
- ✅ Verify backward compatibility (STM32)
- ✅ Run full test suite (416 tests pass)

## Notes

1. **MCXN947 runner behavior**: MCXN947's default runner is "linkserver" but reset always uses OpenOCD because linkserver doesn't provide a standalone reset command.

2. **Temp file cleanup**: J-Link scripts are created in system temp directory and cleaned up immediately after execution. Cleanup is best-effort (doesn't fail the command if cleanup fails).

3. **nrfjprog availability**: The implementation assumes `nrfjprog` is in PATH when resetting nRF devices. Users need Nordic Command Line Tools installed.

4. **Device string format**: J-Link device strings should match SEGGER's device database (e.g., "NRF5340_XXAA_APP", "MCXN947", "RP2040").

5. **Future enhancements**: Could add auto-detection of device string from build artifacts or connected hardware, but current implementation requires explicit `--device` flag for clarity and safety.
